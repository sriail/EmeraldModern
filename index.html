<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/emerald.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Emerald ‚≠ê</title>
    <meta
      name="description"
      content="The Emerald service, your one stop solution for all you're nefarious needs"
    />
    <meta name="og:image" content="/emerald.png" />

    <link rel="prefetch" href="/scram/scramjet.worker.js" />
    <link rel="prefetch" href="/scram/scramjet.shared.js" />
  </head>
  <body>
    <div id="root"></div>
    <input type="password" name="" id="" style="height: 0px; width: 0px; position: absolute; top: -1000px; left: -1000px" />
    <script src="/scram/scramjet.controller.js"></script>
   <script>
  const scramjet = new ScramjetController({
    prefix: "/~/scramjet/",
    files: {
      wasm: "/scram/scramjet.wasm.wasm",
      worker: "/scram/scramjet.worker.js",
      client: "/scram/scramjet.client.js",
      shared: "/scram/scramjet.shared.js",
      sync: "/scram/scramjet.sync.js",
    },
  });
  window.sj = scramjet;
</script>

<script>
  // Enhanced popup interceptor - must run before React
  (function() {
    console.log('[Emerald] Installing popup interceptor...');
    
    const originalOpen = window.open;
    
    // Override window.open at the parent level
    window.open = function(url, target, features) {
      console.log('[Emerald Global] window.open intercepted:', {
        url: url,
        target: target,
        features: features,
        stack: new Error().stack
      });
      
      // Check if this is a proxy URL
      if (url && (url.includes('/~/scramjet/') || url.includes('/~/uv/') || url.includes('about:blank'))) {
        console.log('[Emerald Global] Proxy popup detected!');
        
        // Send message to React app
        setTimeout(() => {
          window.postMessage({
            type: 'PROXY_POPUP',
            url: url,
            target: target,
            timestamp: Date.now()
          }, window.location.origin);
        }, 0);
        
        // Return a fake window object to prevent errors
        return {
          closed: false,
          close: () => {},
          focus: () => {},
          blur: () => {},
          postMessage: () => {}
        };
      }
      
      // Allow other popups
      console.log('[Emerald Global] Allowing non-proxy popup');
      return originalOpen.call(window, url, target, features);
    };
    
    // Also monitor for messages FROM iframes
    window.addEventListener('message', function(e) {
      console.log('[Emerald] Message received:', e.data);
      
      // Scramjet might send messages when it tries to open popups
      if (e.data && typeof e.data === 'object') {
        if (e.data.type === 'open' || e.data.msg === 'open') {
          console.log('[Emerald] Iframe requested popup:', e.data);
          
          window.postMessage({
            type: 'PROXY_POPUP',
            url: e.data.url || e.data.href,
            target: '_blank',
            timestamp: Date.now()
          }, window.location.origin);
        }
      }
    });
    
    console.log('[Emerald] Popup interceptor installed successfully!');
    
    // Test the interceptor immediately
    setTimeout(() => {
      console.log('[Emerald] Testing interceptor...');
      const testResult = window.open('/~/scramjet/test', '_blank');
      console.log('[Emerald] Test result:', testResult);
    }, 1000);
    
  })();
</script>
    <script src="/uv/uv.bundle.js"></script>
    <script src="/uv/uv.config.js"></script>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
