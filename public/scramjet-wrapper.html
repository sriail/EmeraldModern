<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loading...</title>
  <style>html,body,#contentFrame{height:100%;margin:0;padding:0;border:0}</style>
</head>
<body>
  <iframe id="contentFrame" sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-presentation allow-top-navigation-by-user-activation allow-pointer-lock" src="" frameborder="0" width="100%" height="100%"></iframe>

  <script>
    (function () {
      const params = new URLSearchParams(location.search);
      const proxiedUrl = params.get('url');
      const inner = document.getElementById('contentFrame');

      if (!proxiedUrl) {
        inner.srcdoc = '<p style="padding:20px">No url specified</p>';
        return;
      }

      // Forward navigation messages to parent
      window.addEventListener('message', (ev) => {
        try {
          const d = ev.data;
          if (!d || typeof d !== 'object') return;
          if (d && d.type === 'scramjet-nav-request' && d.url) {
            window.parent.postMessage({ type: 'scramjet-nav-request', url: d.url }, '*');
          }
        } catch (e) {
          console.warn('wrapper message error', e);
        }
      }, false);

      inner.src = proxiedUrl;

      // Function to extract and send page metadata
      function updatePageMetadata() {
        try {
          const cw = inner.contentWindow;
          if (!cw || !cw.document) return;

          const doc = cw.document;
          let pageTitle = doc.title || 'Untitled';
          let pageFavicon = '';

          // Try to get favicon
          const faviconLink = doc.querySelector('link[rel~="icon"], link[rel="shortcut icon"]');
          if (faviconLink) {
            pageFavicon = faviconLink.href;
          } else {
            // Try default favicon.ico
            try {
              const url = new URL(cw.location.href);
              pageFavicon = `${url.origin}/favicon.ico`;
            } catch (e) { /* ignore */ }
          }

          // Update wrapper title
          document.title = pageTitle;

          // Send metadata to parent
          window.parent.postMessage({
            type: 'scramjet-metadata-update',
            title: pageTitle,
            favicon: pageFavicon,
            url: cw.location.href
          }, '*');

        } catch (e) {
          console.warn('Could not extract page metadata (cross-origin):', e);
        }
      }

      // Listen for inner iframe load
      inner.addEventListener('load', () => {
        try {
          const cw = inner.contentWindow;
          if (!cw) return;

          // Extract metadata on load
          updatePageMetadata();

          // Set up periodic checking for title changes
          let lastTitle = '';
          const titleCheckInterval = setInterval(() => {
            try {
              const currentTitle = cw.document.title;
              if (currentTitle !== lastTitle) {
                lastTitle = currentTitle;
                updatePageMetadata();
              }
            } catch (e) {
              // Cross-origin - can't check title
              clearInterval(titleCheckInterval);
            }
          }, 1000);

          // Install navigation interception
          try {
            if (!cw.__scramjetNavInstalled) {
              cw.__scramjetNavInstalled = true;

              cw.window.open = function (url, target, features) {
                try {
                  cw.parent.postMessage({ type: 'scramjet-nav-request', url: String(url) }, '*');
                } catch (e) { /* ignore */ }
                return { closed: false, close: () => {}, focus: () => {}, blur: () => {}, postMessage: () => {} };
              };

              cw.document.addEventListener('click', function (e) {
                let a = e.target;
                while (a && a.nodeName !== 'A') a = a.parentElement;
                if (!a) return;
                const href = a.getAttribute('href');
                const target = a.getAttribute('target');
                if (!href) return;
                if (href.startsWith('javascript:') || href.startsWith('#')) return;
                e.preventDefault();
                cw.parent.postMessage({ type: 'scramjet-nav-request', url: new URL(href, cw.location.href).toString() }, '*');
              }, true);

              cw.document.addEventListener('submit', function (e) {
                const form = e.target;
                try {
                  const formAction = form.action || cw.location.href;
                  e.preventDefault();
                  cw.parent.postMessage({ type: 'scramjet-nav-request', url: new URL(formAction, cw.location.href).toString() }, '*');
                } catch (err) { /* ignore */ }
              }, true);
            }
          } catch (injErr) {
            console.warn('Could not inject into proxied page (likely cross-origin):', injErr);
          }
        } catch (e) {
          console.warn('inner load handler', e);
        }
      }, false);
    })();
  </script>
</body>
</html>
